"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@descope/core-js-sdk"),n=require("jwt-decode"),a=require("js-cookie"),i=require("@fingerprintjs/fingerprintjs-pro");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=o(t),s=o(n),l=o(a);const c=(e,t)=>{var n;return["beforeRequest","afterRequest"].reduce(((n,a)=>{var i;return n[a]=[].concat((null===(i=e.hooks)||void 0===i?void 0:i[a])||[]).concat((null==t?void 0:t[a])||[]),n}),null!==(n=e.hooks)&&void 0!==n?n:e.hooks={}),e},u=async e=>{if(!(null==e?void 0:e.ok))return{};const t=await(null==e?void 0:e.clone().json());return(null==t?void 0:t.authInfo)||t||{}},d=async e=>{const t=await u(e);return(null==t?void 0:t.user)||((null==t?void 0:t.hasOwnProperty("userId"))?t:void 0)},g="undefined"!=typeof localStorage,p=(e,t)=>g&&(null===localStorage||void 0===localStorage?void 0:localStorage.setItem(e,t)),f=e=>g&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem(e)),w=e=>g&&(null===localStorage||void 0===localStorage?void 0:localStorage.removeItem(e)),h=(...e)=>{console.debug(...e)},v="undefined"!=typeof window,b=Math.pow(2,31)-1,y="DS",m="DSR";function S(e,t,{cookiePath:n,cookieDomain:a,cookieExpiration:i}){if(t){const o=new Date(1e3*i),r=function(e){const t=window.location.hostname.split("."),n=e.split(".");return t.slice(-n.length).join(".")===e}(a);l.default.set(e,t,{path:n,domain:r?a:void 0,expires:o,sameSite:"Strict",secure:!0})}}function I(e=""){return f(`${e}${m}`)||""}function O(e=""){w(`${e}${m}`),w(`${e}${y}`),l.default.remove(y)}const j=v&&(null===localStorage||void 0===localStorage?void 0:localStorage.getItem("fingerprint.endpoint.url"))||"https://api.descope.com",k="fp",_=(e=!1)=>{const t=localStorage.getItem(k);if(!t)return null;const n=JSON.parse(t);return(new Date).getTime()>n.expiry&&!e?null:n.value},U=async(e,t=j)=>{try{if(_())return;const n=(Date.now().toString(36)+Math.random().toString(36).substring(2)+Math.random().toString(36).substring(2)).substring(0,27),a=new URL(t);a.pathname="/fXj8gt3x8VulJBna/x96Emn69oZwcd7I6";const o=new URL(t);o.pathname="/fXj8gt3x8VulJBna/w78aRZnnDZ3Aqw0I";const r=o.toString()+"?apiKey=<apiKey>&version=<version>&loaderVersion=<loaderVersion>",s=i.load({apiKey:e,endpoint:[a.toString(),i.defaultEndpoint],scriptUrlPattern:[r,i.defaultScriptUrlPattern]}),l=await s,{requestId:c}=await l.get({linkedId:n}),u=((e,t)=>({vsid:e,vrid:t}))(n,c);(e=>{const t={value:e,expiry:(new Date).getTime()+864e5};localStorage.setItem(k,JSON.stringify(t))})(u)}catch(e){console.warn("Could not load fingerprint",e)}},x=e=>{const t=_(!0);return t&&e.body&&(e.body.fpData=t),e},D="dls_last_user_login_id",T="dls_last_user_display_name",A=()=>f(D),K=()=>f(T),R=e=>async(...t)=>{var n;t[1]=t[1]||{};const[,a={}]=t,i=A(),o=K();i&&(null!==(n=a.lastAuth)&&void 0!==n||(a.lastAuth={}),a.lastAuth.loginId=i,a.lastAuth.name=o);return await e(...t)},J=e=>async(...t)=>{const n=await e(...t);return w(D),w(T),n};function C(){const e=[];return{pub:t=>{e.forEach((e=>e(t)))},sub:t=>{const n=e.push(t)-1;return()=>e.splice(n,1)}}}const E=e=>t=>async(...n)=>{const a=await t(...n);return O(e),a};async function N(e){const t=function(e){var t;const n=JSON.parse(e);return n.publicKey.challenge=F(n.publicKey.challenge),n.publicKey.user.id=F(n.publicKey.user.id),null===(t=n.publicKey.excludeCredentials)||void 0===t||t.forEach((e=>{e.id=F(e.id)})),n}(e),n=await navigator.credentials.create(t);return a=n,JSON.stringify({id:a.id,rawId:H(a.rawId),type:a.type,response:{attestationObject:H(a.response.attestationObject),clientDataJSON:H(a.response.clientDataJSON)}});var a}async function $(e){const t=P(e);return V(await navigator.credentials.get(t))}async function q(e,t){const n=P(e);n.signal=t.signal,n.mediation="conditional";return V(await navigator.credentials.get(n))}async function L(e=!1){if(!v)return Promise.resolve(!1);const t=!!(window.PublicKeyCredential&&navigator.credentials&&navigator.credentials.create&&navigator.credentials.get);return t&&e&&PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable():t}function P(e){var t;const n=JSON.parse(e);return n.publicKey.challenge=F(n.publicKey.challenge),null===(t=n.publicKey.allowCredentials)||void 0===t||t.forEach((e=>{e.id=F(e.id)})),n}function V(e){return JSON.stringify({id:e.id,rawId:H(e.rawId),type:e.type,response:{authenticatorData:H(e.response.authenticatorData),clientDataJSON:H(e.response.clientDataJSON),signature:H(e.response.signature),userHandle:e.response.userHandle?H(e.response.userHandle):void 0}})}function F(e){const t=e.replace(/_/g,"/").replace(/-/g,"+");return Uint8Array.from(atob(t),(e=>e.charCodeAt(0))).buffer}function H(e){return btoa(String.fromCharCode.apply(null,new Uint8Array(e))).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,"")}var M,W=(M=e=>({async signUp(t,n){const a=await e.webauthn.signUp.start(t,window.location.origin,n);if(!a.ok)return a;const i=await N(a.data.options);return await e.webauthn.signUp.finish(a.data.transactionId,i)},async signIn(t){const n=await e.webauthn.signIn.start(t,window.location.origin);if(!n.ok)return n;const a=await $(n.data.options);return await e.webauthn.signIn.finish(n.data.transactionId,a)},async signUpOrIn(t){var n;const a=await e.webauthn.signUpOrIn.start(t,window.location.origin);if(!a.ok)return a;if(null===(n=a.data)||void 0===n?void 0:n.create){const t=await N(a.data.options);return await e.webauthn.signUp.finish(a.data.transactionId,t)}{const t=await $(a.data.options);return await e.webauthn.signIn.finish(a.data.transactionId,t)}},async update(t,n){const a=await e.webauthn.update.start(t,window.location.origin,n);if(!a.ok)return a;const i=await N(a.data.options);return await e.webauthn.update.finish(a.data.transactionId,i)},helpers:{create:N,get:$,isSupported:L,conditional:q}}),(...e)=>{const t=M(...e);return Object.assign(t.signUp,e[0].webauthn.signUp),Object.assign(t.signIn,e[0].webauthn.signIn),Object.assign(t.signUpOrIn,e[0].webauthn.signUpOrIn),Object.assign(t.update,e[0].webauthn.update),t});const G={config:"/fedcm/config"},B=(e,t)=>({async oneTap(t,n,a,i){const o=null!=t?t:"google",r=await e.oauth.startNative(o,a,!0);if(!r.ok)return r;const{clientId:s,stateId:l,nonce:c}=r.data,u=await async function(){return new Promise(((e,t)=>{if(window.google)return void e(window.google.accounts.id);let n=document.getElementById("google-gsi-client-script");n||(n=document.createElement("script"),document.head.appendChild(n),n.async=!0,n.defer=!0,n.id="google-gsi-client-script",n.src="https://accounts.google.com/gsi/client"),n.onload=function(){window.google?e(window.google.accounts.id):t("Failed to load Google GSI client script - not loaded properly")},n.onerror=function(){t("Failed to load Google GSI client script - failed to load")}}))}();return new Promise((t=>{var a,r;u.initialize(Object.assign(Object.assign({},n),{itp_support:null===(a=null==n?void 0:n.itp_support)||void 0===a||a,use_fedcm_for_prompt:null===(r=null==n?void 0:n.use_fedcm_for_prompt)||void 0===r||r,client_id:s,callback:n=>{t(e.oauth.finishNative(o,l,"","",n.credential))},nonce:c})),u.prompt((e=>{(null==e?void 0:e.isSkippedMoment())&&(null==i||i())}))}))},async launch(n){var a;const i={identity:{context:n||"signin",providers:[{configURL:e.httpClient.buildUrl(t+G.config),clientId:t}]}},o=await(null===(a=navigator.credentials)||void 0===a?void 0:a.get(i));return e.refresh(o.token)},isSupported:()=>v&&"IdentityCredential"in window});var Z=e=>Object.assign(Object.assign({},e.flow),{start:async(...t)=>{const n=await L(),a=Object.assign(Object.assign({location:window.location.href},t[1]),{deviceInfo:{webAuthnSupport:n},startOptionsVersion:1});return t[1]=a,e.flow.start(...t)}});const X=function(...e){return t=>e.reduce(((e,t)=>t(e)),t)}((t=>n=>{var{fpKey:a,fpLoad:i}=n,o=e.__rest(n,["fpKey","fpLoad"]);return v?(a&&i&&U(a).catch((()=>null)),t(c(o,{beforeRequest:x}))):(console.warn("Fingerprint is a client side only capability and will not work when running in the server"),t(o))}),(n=>a=>{var{autoRefresh:i}=a,o=e.__rest(a,["autoRefresh"]);if(!i)return n(o);const{clearAllTimers:r,setTimer:l}=(()=>{const e=[];return{clearAllTimers:()=>{for(;e.length;)clearTimeout(e.pop())},setTimer:(t,n)=>{e.push(setTimeout(t,n))}}})();let d,g;v&&document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&new Date>d&&(h("Expiration time passed, refreshing session"),p.refresh(I()||g))}));const p=n(c(o,{afterRequest:async(e,t)=>{const{refreshJwt:n,sessionJwt:a}=await u(t);if(401===(null==t?void 0:t.status))h("Received 401, canceling all timers"),r();else if(a){if(d=(e=>{try{const t=s.default(e);if(t.exp)return new Date(1e3*t.exp)}catch(e){return null}})(a),!d)return void h("Could not extract expiration time from session token");g=n;let e=((i=d)?i.getTime()-(new Date).getTime():0)-2e4;e>b&&(h(`Timeout is too large (${e}ms), setting it to ${b}ms`),e=b),r();const t=new Date(Date.now()+e).toLocaleTimeString("en-US",{hour12:!1});h(`Setting refresh timer for ${t}. (${e}ms)`),l((()=>{h("Refreshing session due to timer"),p.refresh(I()||n)}),e)}var i}}));return t.wrapWith(p,["logout","logoutAll"],(e=>async(...t)=>{const n=await e(...t);return h("Clearing all timers"),r(),n}))}),(e=>t=>e(Object.assign(Object.assign({},t),{baseHeaders:Object.assign({"x-descope-sdk-name":"web-js","x-descope-sdk-version":"1.13.1"},t.baseHeaders)}))),(e=>n=>{const a=C(),i=C(),o=e(c(n,{afterRequest:async(e,t)=>{if(401===(null==t?void 0:t.status))a.pub(null),i.pub(null);else{const e=await d(t);e&&i.pub(e);const{sessionJwt:n}=await u(t);n&&a.pub(n)}}})),r=t.wrapWith(o,["logout","logoutAll"],(e=>async(...t)=>{const n=await e(...t);return a.pub(null),i.pub(null),n}));return Object.assign(r,{onSessionTokenChange:a.sub,onUserChange:i.sub})}),(n=>a=>{var{storeLastAuthenticatedUser:i=!0}=a,o=e.__rest(a,["storeLastAuthenticatedUser"]);if(!i)return Object.assign(n(o),{getLastUserLoginId:A,getLastUserDisplayName:K});const r=n(c(o,{afterRequest:async(e,t)=>{var n;const a=await d(t),i=null===(n=null==a?void 0:a.loginIds)||void 0===n?void 0:n[0],o=null==a?void 0:a.name;i&&((e=>{p(D,e)})(i),(e=>{p(T,e)})(o))}}));let s=t.wrapWith(r,["flow.start"],R);return s=t.wrapWith(s,["logout","logoutAll"],J),Object.assign(s,{getLastUserLoginId:A,getLastUserDisplayName:K})}),(n=>a=>{var{persistTokens:i,sessionTokenViaCookie:o,storagePrefix:r}=a,s=e.__rest(a,["persistTokens","sessionTokenViaCookie","storagePrefix"]);if(!i||!v)return i&&console.warn("Storing auth tokens in local storage and cookies are a client side only capabilities and will not be done when running in the server"),n(s);const d=n(c(s,{beforeRequest:(g=r,e=>Object.assign(e,{token:e.token||I(g)})),afterRequest:async(t,n)=>{const a=/^\/v\d+\/mgmt\//.test(t.path);401===(null==n?void 0:n.status)?a||O(r):((t={},n,a)=>{var{refreshJwt:i,sessionJwt:o}=t,r=e.__rest(t,["refreshJwt","sessionJwt"]);void 0===n&&(n=!1),void 0===a&&(a=""),i&&p(`${a}${m}`,i),o&&(n?S(y,o,r):p(`${a}${y}`,o))})(await u(n),o,r)}}));var g;const w=t.wrapWith(d,["logout","logoutAll"],E(r));return Object.assign(w,{getRefreshToken:()=>I(r),getSessionToken:()=>function(e=""){return l.default.get(y)||f(`${e}${y}`)||""}(r)})}))(((...e)=>{const t=r.default(...e);return Object.assign(Object.assign({},t),{flow:Z(t),webauthn:W(t),fedcm:B(t,e[0].projectId)})}));exports.REFRESH_TOKEN_KEY=m,exports.SESSION_TOKEN_KEY=y,exports.clearFingerprintData=()=>{localStorage.removeItem(k)},exports.default=X,exports.ensureFingerprintIds=U;
//# sourceMappingURL=index.cjs.js.map
